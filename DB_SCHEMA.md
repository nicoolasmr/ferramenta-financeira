# Database Schema

## Tables

### `public.organizations`
- `id` (uuid, pk)
- `name` (text)
- `slug` (text, unique)
- `created_at` (timestamptz)

### `public.users`
- `id` (uuid, pk, foreign key to auth.users)
- `email` (text)
- `full_name` (text)
- `avatar_url` (text)
- `created_at` (timestamptz)

### `public.memberships`
- `id` (uuid, pk)
- `org_id` (uuid, fk organizations)
- `user_id` (uuid, fk users)
- `role` (text: owner, admin, member, viewer)
- `created_at` (timestamptz)

### `public.products`
- `id` (uuid, pk)
- `org_id` (uuid, fk organizations)
- `name` (text)
- `description` (text)
- `price_cents` (int)
- `active` (boolean)
- `created_at` (timestamptz)

### `public.customers`
- `id` (uuid, pk)
- `org_id` (uuid, fk organizations)
- `name` (text)
- `email` (text)
- `phone` (text)
- `document` (text)
- `tags` (jsonb)
- `source` (text)
- `created_at` (timestamptz)

### `public.orders`
- `id` (uuid, pk)
- `org_id` (uuid, fk organizations)
- `customer_id` (uuid, fk customers)
- `source` (text)
- `external_id` (text)
- `status` (text)
- `currency` (text)
- `gross_amount_cents` (int)
- `net_amount_cents` (int)
- `fees_cents` (int)
- `tax_cents` (int)
- `notes` (text)
- `purchase_datetime` (timestamptz)
- `created_at` (timestamptz)

### `public.order_items`
- `id` (uuid, pk)
- `org_id` (uuid, fk organizations)
- `order_id` (uuid, fk orders)
- `product_id` (uuid, fk products)
- `qty` (int)
- `unit_price_cents` (int)
- `discount_cents` (int)
- `created_at` (timestamptz)

### `public.payments`
- `id` (uuid, pk)
- `org_id` (uuid, fk organizations)
- `order_id` (uuid, fk orders)
- `method` (text)
- `gateway` (text)
- `status` (text)
- `installments` (int)
- `amount_cents` (int)
- `external_id` (text)
- `paid_at` (timestamptz)
- `created_at` (timestamptz)

### `public.refunds`
- `id` (uuid, pk)
- `org_id` (uuid, fk organizations)
- `order_id` (uuid, fk orders)
- `payment_id` (uuid, fk payments, nullable)
- `amount_cents` (int)
- `reason` (text)
- `refunded_at` (timestamptz)
- `created_at` (timestamptz)

### `public.payouts`
- `id` (uuid, pk)
- `org_id` (uuid, fk organizations)
- `source` (text)
- `amount_cents` (int)
- `external_id` (text)
- `payout_datetime` (timestamptz)
- `created_at` (timestamptz)

### `public.integrations`
- `id` (uuid, pk)
- `org_id` (uuid, fk organizations)
- `provider` (text)
- `status` (text)
- `config` (jsonb)
- `created_at` (timestamptz)

### `public.audit_logs`
- `id` (uuid, pk)
- `org_id` (uuid, fk organizations)
- `user_id` (uuid, fk users)
- `action` (text)
- `entity` (text)
- `entity_id` (text)
- `before` (jsonb)
- `after` (jsonb)
- `created_at` (timestamptz)

### `public.projects` (Module: Projects)
- `id` (uuid, pk)
- `org_id` (uuid, fk organizations)
- `name` (text)
- `client_name` (text)
- `settings` (jsonb)
- `created_at` (timestamptz)

### `public.project_members` (Module: Projects)
- `id` (uuid, pk)
- `org_id` (uuid, fk organizations)
- `project_id` (uuid, fk projects)
- `user_id` (uuid, fk auth.users)
- `role` (text)
- `created_at` (timestamptz)

### `public.enrollments` (Module: Projects)
- `id` (uuid, pk)
- `org_id` (uuid, fk organizations)
- `project_id` (uuid, fk projects)
- `customer_id` (uuid, fk customers)
- `niche` (text)
- `status` (text)
- `situation` (text)
- `cycle_start_date` (date)
- `cycle_end_date` (date)
- `cycle_months` (int)
- `initial_diagnosis` (text)
- `meeting1_at` (timestamptz)
- `meeting1_notes` (text)
- `followup_notes` (text)
- `folder_url` (text)
- `contract_signed_at` (timestamptz)
- `contract_file_path` (text)
- `created_at` (timestamptz)

### `public.payment_plans` (Module: Projects)
- `id` (uuid, pk)
- `org_id` (uuid, fk organizations)
- `enrollment_id` (uuid, fk enrollments)
- `total_amount_cents` (int)
- `currency` (text)
- `entry_amount_cents` (int)
- `entry_method` (text)
- `entry_status` (text)
- `entry_paid_at` (timestamptz)
- `installments_count` (int)
- `installments_gateway` (text)
- `schedule_rule` (jsonb)
- `notes` (text)
- `created_at` (timestamptz)

### `public.installments` (Module: Projects)
- `id` (uuid, pk)
- `org_id` (uuid, fk organizations)
- `plan_id` (uuid, fk payment_plans)
- `installment_number` (int)
- `amount_cents` (int)
- `due_date` (date)
- `status` (text)
- `paid_at` (timestamptz)
- `method` (text)
- `external_id` (text)
- `receipt_file_path` (text)
- `notes` (text)
- `created_at` (timestamptz)

## RLS Policies
All tables must have RLS enabled.
Policy template: `auth.uid() in (select user_id from memberships where org_id = table.org_id)`
